<!DOCTYPE html>
<html>
<head>
  <title>SSL validity check</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <style>
    table {
      border: 1px solid #666;   
      width: 100%;
    }
    th {
      background: #f8f8f8; 
      font-weight: bold;    
      padding: 2px;
      text-align: left;
    } 
  </style>
  <script >

    var sites = [];

    $.ajax({
      url: "/api/v1/get-domains/zpoto",
      method: "get",
      success: function(result) {
        console.log(Object.keys(result));
        sites = Object.keys(result);
        get_validity();
      }
    });

function add_domain() {
var domain = document.getElementById("domain").value
    $.ajax({
      url: "/api/v1/add-domain/zpoto/" + domain,
      method: "get",
      success: function(result) {
        console.log(result);
        location.reload();
      }
    });
}

function del_domain(domain) {
console.log(domain);
  $.ajax({
    url: "/api/v1/del-domain/zpoto/" + domain,
    method: "get",
    success: function(result) {
      console.log(result);
      location.reload();
    }
  });
}
var ajax_caller = function(data) {
    return $.ajax({
        url: data.url + data.domain, 
        method: data.method,
        success: function(result) {
          result.domain = data.domain;
          //console.log(result);
          drawRow(result);
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) { 
          var result = XMLHttpRequest.responseJSON.error;
          result.domain = data.domain;
          drawInvalidRow(result); 
        } 
    });
};
var ajax_calls = [];

function get_validity () {
    for( i = 0; i < sites.length; i++){
      var domain = sites[i];
      ajax_calls.push(ajax_caller({
        method: "get",
        url: "/api/v1/ssl-validity/",
        domain: domain
      }));
    }
}

function drawRow(rowData) {
    var color = "";
    if ( rowData.days_remaining >= 29 && rowData.valid ) { color = "bgcolor='lightgreen'"; }
    else { color = "bgcolor='red'"; } 
    var row = $("<tr " + color + "/>")
    $("#ssltable").append(row);
    row.append($("<td>" + rowData.domain + "</td>"));
    row.append($("<td>" + rowData.valid_from + "</td>"));
    row.append($("<td>" + rowData.valid_to + "</td>"));
    row.append($("<td>" + rowData.days_remaining + "</td>"));
    row.append($("<td>" + rowData.valid + "</td>"));
    row.append($("<td><button value='" + rowData.domain + "' onclick='del_domain(this.value);'>Delete</button></td>"));
}

function drawInvalidRow(err) {
    var row = $("<tr bgcolor='gray' />")
    $("#ssltableinvalid").append(row);
    row.append($("<td>" + err.domain + "</td>"));
    row.append($("<td>" + err.code + "</td>"));
    row.append($("<td>" + err.errno + "</td>"));
    row.append($("<td>" + err.port + "</td>"));
    row.append($("<td>" + err.syscall + "</td>"));
    row.append($("<td><button value='" + err.domain + "' onclick='del_domain(this.value);'>Delete invalid</button></td>"));
}

</script>
</head>
<body>

<form method="" action="" id="add_domain" onsubmit="add_domain(); return false;"></form>

<table id="ssltableinvalid">
</table>
<table id="ssltable">
    <tr>
        <td><input style="width:100%; padding-left:0px; padding-right:0px;" type="text" name="domain" form="add_domain" id="domain" /></td>
        <td><input type="submit" value="Add domain" form="add_domain" /></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <th>Domain</th>
        <th>From</th>
        <th>To</th>
        <th>Remaining</th>
        <th>Valid</th>
        <th></th>
    </tr>
</table>

</body>
</html>
